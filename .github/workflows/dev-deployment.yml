name: Deploy Dev-Stage CI

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Docker Image CI"]  
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: dev-stage

    steps:
      - name: Log in to docker.io
        uses: redhat-actions/podman-login@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          registry: docker.io
      - name: Fetch current configs
        run: |
          ssh deploy@localhost "cd /home/deploy/apps/bot-pilot-config"
          echo "Fetch current config files from bot-pilot-config"
          git fetch
          echo "Pull new config files for dev-stage"
          git pull
          
      - name: Deploy application services
        run: |
          ssh deploy@localhost "cd /home/deploy/deployment"
          echo "Stopping all services in dev-stage"
          podman-compose down
          echo "Start services in dev-stage"
          podman-compose up --detach
